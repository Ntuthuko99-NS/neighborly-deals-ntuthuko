import React, { useState } from 'react';
import { base44 } from '@/api/base44Client';
import { useForm } from 'react-hook-form';
import { createPageUrl } from '@/utils';
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Loader2, UploadCloud, MapPin, X } from "lucide-react";
import { toast } from "sonner";

export default function CreateListing() {
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [imageFiles, setImageFiles] = useState([]);
    const [imageUrls, setImageUrls] = useState([]);
    const [isUploading, setIsUploading] = useState(false);
    const [locationLoading, setLocationLoading] = useState(false);
    const [location, setLocation] = useState({ lat: null, lng: null, suburb: "" });

    const { register, handleSubmit, setValue, formState: { errors } } = useForm();

    const handleImageUpload = async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        setIsUploading(true);
        const newUrls = [];

        try {
            for (const file of files) {
                // In a real app, we'd compress here
                const res = await base44.integrations.Core.UploadFile({ file });
                if (res.file_url) {
                    newUrls.push(res.file_url);
                }
            }
            setImageUrls([...imageUrls, ...newUrls]);
        } catch (error) {
            toast.error("Failed to upload images");
            console.error(error);
        } finally {
            setIsUploading(false);
        }
    };

    const removeImage = (index) => {
        setImageUrls(imageUrls.filter((_, i) => i !== index));
    };

    const getCurrentLocation = () => {
        setLocationLoading(true);
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude, longitude } = position.coords;
                    // Here we might use a geocoding integration if available, or just store coords
                    // For now, just coords. User can manually type suburb.
                    setLocation(prev => ({ ...prev, lat: latitude, lng: longitude }));
                    setValue('lat', latitude);
                    setValue('lng', longitude);
                    setLocationLoading(false);
                    toast.success("Location fetched!");
                },
                (error) => {
                    console.error(error);
                    toast.error("Could not get location");
                    setLocationLoading(false);
                }
            );
        }
    };

    const onSubmit = async (data) => {
        if (imageUrls.length === 0) {
            toast.error("Please add at least one photo");
            return;
        }

        setIsSubmitting(true);
        try {
            const user = await base44.auth.me().catch(() => null);
            if (!user) {
                base44.auth.redirectToLogin();
                return;
            }

            await base44.entities.Listing.create({
                ...data,
                price: parseFloat(data.price),
                images: imageUrls,
                lat: location.lat,
                lng: location.lng,
                suburb: location.suburb || data.suburb_input,
                status: 'active'
            });

            toast.success("Listing published!");
            window.location.href = createPageUrl('Home');
        } catch (error) {
            console.error(error);
            toast.error("Failed to create listing");
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div className="max-w-2xl mx-auto">
            <div className="mb-8">
                <h1 className="text-3xl font-bold text-slate-900">Sell an Item</h1>
                <p className="text-slate-500">List your item for sale in your neighborhood</p>
            </div>

            <form onSubmit={handleSubmit(onSubmit)} className="space-y-8 bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                {/* Photo Upload */}
                <div className="space-y-4">
                    <Label className="text-base font-semibold">Photos</Label>
                    <div className="grid grid-cols-3 gap-4">
                        {imageUrls.map((url, idx) => (
                            <div key={idx} className="relative aspect-square rounded-xl overflow-hidden border border-slate-200 group">
                                <img src={url} alt="Preview" className="w-full h-full object-cover" />
                                <button 
                                    type="button"
                                    onClick={() => removeImage(idx)}
                                    className="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                                >
                                    <X className="w-4 h-4" />
                                </button>
                            </div>
                        ))}
                        <label className="aspect-square rounded-xl border-2 border-dashed border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 flex flex-col items-center justify-center cursor-pointer transition-all">
                            {isUploading ? (
                                <Loader2 className="w-8 h-8 text-indigo-500 animate-spin" />
                            ) : (
                                <>
                                    <UploadCloud className="w-8 h-8 text-slate-400 mb-2" />
                                    <span className="text-xs font-medium text-slate-500">Add Photo</span>
                                </>
                            )}
                            <input 
                                type="file" 
                                accept="image/*" 
                                multiple 
                                className="hidden" 
                                onChange={handleImageUpload}
                                disabled={isUploading}
                            />
                        </label>
                    </div>
                    <p className="text-xs text-slate-400">Add up to 10 photos. First photo will be the cover.</p>
                </div>

                <div className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="title">Title</Label>
                        <Input 
                            id="title" 
                            placeholder="What are you selling?" 
                            {...register("title", { required: true })}
                            className="bg-slate-50 border-slate-200 focus:bg-white transition-colors"
                        />
                        {errors.title && <span className="text-red-500 text-xs">Title is required</span>}
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="price">Price (ZAR)</Label>
                        <div className="relative">
                            <span className="absolute left-3 top-2.5 text-slate-500">R</span>
                            <Input 
                                id="price" 
                                type="number" 
                                placeholder="0.00" 
                                {...register("price", { required: true })}
                                className="pl-8 bg-slate-50 border-slate-200 focus:bg-white"
                            />
                        </div>
                        {errors.price && <span className="text-red-500 text-xs">Price is required</span>}
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="category">Category</Label>
                        <Select onValueChange={(val) => setValue("category", val)} required>
                            <SelectTrigger className="bg-slate-50 border-slate-200">
                                <SelectValue placeholder="Select a category" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="electronics">Electronics</SelectItem>
                                <SelectItem value="furniture">Furniture</SelectItem>
                                <SelectItem value="vehicles">Vehicles</SelectItem>
                                <SelectItem value="clothing">Clothing</SelectItem>
                                <SelectItem value="hobbies">Hobbies</SelectItem>
                                <SelectItem value="property">Property</SelectItem>
                                <SelectItem value="services">Services</SelectItem>
                                <SelectItem value="other">Other</SelectItem>
                            </SelectContent>
                        </Select>
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="condition">Condition</Label>
                        <Select onValueChange={(val) => setValue("condition", val)} defaultValue="good">
                            <SelectTrigger className="bg-slate-50 border-slate-200">
                                <SelectValue placeholder="Select condition" />
                            </SelectTrigger>
                            <SelectContent>
                                <SelectItem value="new">New</SelectItem>
                                <SelectItem value="like_new">Like New</SelectItem>
                                <SelectItem value="good">Good</SelectItem>
                                <SelectItem value="fair">Fair</SelectItem>
                                <SelectItem value="poor">Poor</SelectItem>
                            </SelectContent>
                        </Select>
                    </div>

                    <div className="space-y-2">
                        <Label htmlFor="description">Description</Label>
                        <Textarea 
                            id="description" 
                            placeholder="Describe your item... (brand, size, color, flaws)" 
                            className="min-h-[120px] bg-slate-50 border-slate-200 focus:bg-white"
                            {...register("description")}
                        />
                    </div>

                    <div className="space-y-2">
                        <Label>Location</Label>
                        <div className="flex gap-2">
                            <Button 
                                type="button" 
                                variant="outline" 
                                className="shrink-0"
                                onClick={getCurrentLocation}
                                disabled={locationLoading}
                            >
                                {locationLoading ? <Loader2 className="w-4 h-4 animate-spin" /> : <MapPin className="w-4 h-4" />}
                            </Button>
                            <Input 
                                placeholder="Suburb / Area" 
                                value={location.suburb}
                                onChange={(e) => setLocation({...location, suburb: e.target.value})}
                                {...register("suburb_input", { required: !location.lat })} // required if no gps
                                className="bg-slate-50 border-slate-200"
                            />
                        </div>
                        {location.lat && <p className="text-xs text-green-600 flex items-center gap-1"><MapPin className="w-3 h-3"/> GPS Coordinates attached</p>}
                    </div>
                </div>

                <div className="pt-4">
                    <Button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 h-12 text-lg font-semibold rounded-xl" disabled={isSubmitting}>
                        {isSubmitting ? (
                            <span className="flex items-center gap-2">
                                <Loader2 className="w-5 h-5 animate-spin" /> Publishing...
                            </span>
                        ) : (
                            "Post Listing"
                        )}
                    </Button>
                </div>
            </form>
        </div>
    );
}
