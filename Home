import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { Link } from "react-router-dom";
import { createPageUrl } from "@/utils";
import { 
    Search, 
    Filter, 
    MapPin, 
    Heart, 
    Tag, 
    Clock,
    ChevronDown,
    Loader2,
    Grid,
    List
} from "lucide-react";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import { Skeleton } from "@/components/ui/skeleton";
import { formatDistanceToNow } from "date-fns";

export default function Home() {
    const [listings, setListings] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState("");
    const [category, setCategory] = useState("all");
    const [viewMode, setViewMode] = useState("grid");

    const categories = [
        { id: "all", name: "All Categories", icon: "ðŸ·ï¸" },
        { id: "electronics", name: "Electronics", icon: "ðŸ’»" },
        { id: "furniture", name: "Furniture", icon: "ðŸ›‹ï¸" },
        { id: "vehicles", name: "Vehicles", icon: "ðŸš—" },
        { id: "clothing", name: "Clothing", icon: "ðŸ‘•" },
        { id: "hobbies", name: "Hobbies", icon: "ðŸŽ¨" },
        { id: "property", name: "Property", icon: "ðŸ " },
        { id: "services", name: "Services", icon: "ðŸ› ï¸" },
    ];

    useEffect(() => {
        fetchListings();
    }, [category]);

    const fetchListings = async () => {
        setLoading(true);
        try {
            let query = { status: "active" };
            if (category !== "all") {
                query.category = category;
            }
            // We'll handle text search client-side for now as simple filter
            const data = await base44.entities.Listing.list({
                filter: query,
                sort: { created_date: -1 },
                limit: 50
            });
            setListings(data);
        } catch (error) {
            console.error("Error fetching listings:", error);
        } finally {
            setLoading(false);
        }
    };

    const filteredListings = listings.filter(item => 
        item.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
        item.suburb?.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
        <div className="space-y-8">
            {/* Hero / Search Section */}
            <section className="relative rounded-3xl overflow-hidden bg-slate-900 text-white p-8 md:p-16 text-center">
                <div className="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1556761175-5973dc0f32e7?q=80&w=2664&auto=format&fit=crop')] bg-cover bg-center opacity-20"></div>
                <div className="relative z-10 max-w-2xl mx-auto space-y-6">
                    <h1 className="text-4xl md:text-5xl font-extrabold tracking-tight">
                        Discover gems in your neighborhood
                    </h1>
                    <p className="text-lg text-slate-300">
                        Buy, sell, and trade with people right next door. Safe, simple, and local.
                    </p>
                    
                    <div className="flex gap-2 p-2 bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 shadow-2xl">
                        <div className="relative flex-1">
                            <Search className="absolute left-4 top-3.5 w-5 h-5 text-slate-400" />
                            <Input 
                                placeholder="Search for items, neighborhoods..." 
                                className="pl-12 bg-white/90 border-0 h-12 text-slate-900 placeholder:text-slate-500 rounded-xl focus-visible:ring-0"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <Button className="h-12 px-8 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-semibold transition-all">
                            Search
                        </Button>
                    </div>
                </div>
            </section>

            {/* Filters */}
            <section className="flex flex-col md:flex-row gap-4 items-center justify-between sticky top-16 md:top-20 z-40 bg-gray-50/95 backdrop-blur-sm py-4 -mx-4 px-4 md:mx-0 md:px-0">
                <div className="flex gap-2 overflow-x-auto pb-2 md:pb-0 w-full md:w-auto no-scrollbar">
                    {categories.map((cat) => (
                        <button
                            key={cat.id}
                            onClick={() => setCategory(cat.id)}
                            className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all border ${
                                category === cat.id
                                    ? "bg-slate-900 text-white border-slate-900 shadow-md transform scale-105"
                                    : "bg-white text-slate-600 border-slate-200 hover:border-slate-400 hover:bg-slate-50"
                            }`}
                        >
                            <span>{cat.icon}</span>
                            {cat.name}
                        </button>
                    ))}
                </div>

                <div className="flex items-center gap-3 w-full md:w-auto justify-end">
                    <Select defaultValue="newest">
                        <SelectTrigger className="w-[140px] bg-white rounded-xl border-slate-200">
                            <SelectValue placeholder="Sort by" />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="newest">Newest First</SelectItem>
                            <SelectItem value="price_low">Price: Low to High</SelectItem>
                            <SelectItem value="price_high">Price: High to Low</SelectItem>
                            <SelectItem value="nearest">Nearest</SelectItem>
                        </SelectContent>
                    </Select>
                    
                    <div className="bg-white border border-slate-200 rounded-xl p-1 flex">
                        <Button 
                            variant="ghost" 
                            size="icon" 
                            className={`h-8 w-8 rounded-lg ${viewMode === 'grid' ? 'bg-slate-100' : ''}`}
                            onClick={() => setViewMode('grid')}
                        >
                            <Grid className="w-4 h-4" />
                        </Button>
                        <Button 
                            variant="ghost" 
                            size="icon" 
                            className={`h-8 w-8 rounded-lg ${viewMode === 'list' ? 'bg-slate-100' : ''}`}
                            onClick={() => setViewMode('list')}
                        >
                            <List className="w-4 h-4" />
                        </Button>
                    </div>
                </div>
            </section>

            {/* Listings Grid */}
            {loading ? (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    {[1, 2, 3, 4, 5, 6, 7, 8].map((i) => (
                        <div key={i} className="space-y-3">
                            <Skeleton className="h-64 w-full rounded-2xl" />
                            <div className="space-y-2">
                                <Skeleton className="h-4 w-3/4" />
                                <Skeleton className="h-4 w-1/2" />
                            </div>
                        </div>
                    ))}
                </div>
            ) : filteredListings.length > 0 ? (
                <div className={`grid gap-6 ${
                    viewMode === 'grid' 
                        ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-4' 
                        : 'grid-cols-1'
                }`}>
                    {filteredListings.map((listing) => (
                        <Link 
                            key={listing.id} 
                            to={createPageUrl(`ListingDetails?id=${listing.id}`)}
                            className={`group bg-white rounded-2xl border border-slate-200 overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 ${
                                viewMode === 'list' ? 'flex flex-row h-48' : 'flex flex-col'
                            }`}
                        >
                            <div className={`relative bg-slate-100 overflow-hidden ${
                                viewMode === 'list' ? 'w-48 h-full shrink-0' : 'aspect-[4/3] w-full'
                            }`}>
                                <img 
                                    src={listing.images?.[0] || "https://via.placeholder.com/400?text=No+Image"} 
                                    alt={listing.title}
                                    className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                                />
                                <div className="absolute top-3 right-3">
                                    <button className="p-2 bg-white/80 backdrop-blur-sm rounded-full hover:bg-white text-slate-600 hover:text-red-500 transition-colors shadow-sm">
                                        <Heart className="w-4 h-4" />
                                    </button>
                                </div>
                                <Badge className="absolute bottom-3 left-3 bg-black/50 backdrop-blur-md hover:bg-black/60 border-0 text-white">
                                    ZAR {listing.price?.toLocaleString()}
                                </Badge>
                            </div>
                            
                            <div className="p-4 flex flex-col flex-1 justify-between">
                                <div className="space-y-1">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-bold text-slate-900 line-clamp-1 group-hover:text-indigo-600 transition-colors">
                                            {listing.title}
                                        </h3>
                                    </div>
                                    <p className="text-slate-500 text-sm line-clamp-2">{listing.description}</p>
                                </div>
                                
                                <div className="mt-4 flex items-center justify-between text-xs text-slate-400 font-medium">
                                    <div className="flex items-center gap-1">
                                        <MapPin className="w-3 h-3" />
                                        {listing.suburb || "Nearby"}
                                    </div>
                                    <div className="flex items-center gap-1">
                                        <Clock className="w-3 h-3" />
                                        {listing.created_date ? formatDistanceToNow(new Date(listing.created_date), { addSuffix: true }) : 'Just now'}
                                    </div>
                                </div>
                            </div>
                        </Link>
                    ))}
                </div>
            ) : (
                <div className="text-center py-24 bg-white rounded-3xl border border-dashed border-slate-200">
                    <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <Search className="w-8 h-8 text-slate-400" />
                    </div>
                    <h3 className="text-lg font-semibold text-slate-900">No items found</h3>
                    <p className="text-slate-500 max-w-xs mx-auto mt-2">
                        We couldn't find any listings matching your search. Try adjusting your filters or search term.
                    </p>
                    <Button 
                        className="mt-6" 
                        variant="outline"
                        onClick={() => {
                            setCategory("all");
                            setSearchTerm("");
                        }}
                    >
                        Clear Filters
                    </Button>
                </div>
            )}
        </div>
    );
}
