import React, { useState, useEffect } from 'react';
import { base44 } from '@/api/base44Client';
import { createPageUrl } from '@/utils';
import { Link } from 'react-router-dom';
import { Button } from "@/components/ui/button";
import { Loader2, Send, User, Image as ImageIcon } from "lucide-react";
import { formatDistanceToNow } from 'date-fns';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";

export default function Messages() {
    const [conversations, setConversations] = useState([]);
    const [selectedConversation, setSelectedConversation] = useState(null);
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState("");
    const [loading, setLoading] = useState(true);
    const [currentUser, setCurrentUser] = useState(null);

    useEffect(() => {
        const init = async () => {
            try {
                const user = await base44.auth.me();
                setCurrentUser(user);
                await fetchConversations(user);
            } catch (e) {
                base44.auth.redirectToLogin();
            }
        };
        init();
    }, []);

    const fetchConversations = async (user) => {
        setLoading(true);
        try {
            // Fetch messages received
            const received = await base44.entities.Message.list({
                filter: { to_user_id: user.id },
                sort: { created_date: -1 },
                limit: 100
            });

            // Fetch messages sent
            const sent = await base44.entities.Message.list({
                filter: { from_user_id: user.id },
                sort: { created_date: -1 },
                limit: 100
            });

            const allMessages = [...received, ...sent].sort((a, b) => 
                new Date(b.created_date) - new Date(a.created_date)
            );

            const groups = {};
            
            for (const msg of allMessages) {
                // Determine the "other" user
                const isSender = msg.from_user_id === user.id;
                const otherId = isSender ? msg.to_user_id : msg.from_user_id;
                const otherEmail = isSender ? null : msg.created_by; // fallback if we don't have email

                const key = `${msg.listing_id}-${otherId}`;
                
                if (!groups[key]) {
                    groups[key] = {
                        listing_id: msg.listing_id,
                        other_user_id: otherId,
                        other_user_email: otherEmail, // might be null if I initiated and they haven't replied
                        last_message: msg,
                        messages: []
                    };
                }
                groups[key].messages.push(msg);
            }
            
            // Enhance with listing and user details
            const convs = await Promise.all(Object.values(groups).map(async (group) => {
                const [listings, users] = await Promise.all([
                    base44.entities.Listing.list({ filter: { id: group.listing_id }, limit: 1 }),
                    base44.entities.User.list({ filter: { id: group.other_user_id }, limit: 1 })
                ]);

                return {
                    ...group,
                    listing: listings[0] || { title: "Unknown Item" },
                    other_user_name: users[0]?.full_name || "User",
                    other_user_email: users[0]?.email || group.other_user_email
                };
            }));
            
            setConversations(convs);
            
        } catch (error) {
            console.error("Error fetching messages", error);
        } finally {
            setLoading(false);
        }
    };

    const openConversation = async (conv) => {
        setSelectedConversation(conv);
        // Fetch full history for this thread including my sent messages
        // This requires filtering messages where listing_id = X AND (to_user_id = me OR to_user_id = other)
        // We only have `to_user_id` in schema.
        
        const chatMsgs = await base44.entities.Message.list({
            filter: { listing_id: conv.listing_id },
            sort: { created_date: 1 },
            limit: 200
        });
        
        // Filter client side to ensure it's between these two people
        // (Since multiple people might message about same listing)
        const relevant = chatMsgs.filter(m => 
            (m.created_by === conv.other_user_email || m.created_by === currentUser.email)
        );
        
        setMessages(relevant);
    };

    const sendMessage = async (e) => {
        e.preventDefault();
        if (!newMessage.trim() || !selectedConversation) return;

        try {
            // We need the ID of the other user to set `to_user_id`.
            // In our group logic we only captured email.
            // We need to resolve email to ID. 
            // For now, I'll just put the email in `to_user_id` field if the backend allows string? 
            // Schema says string. But standard is ID. 
            // Let's assume we can't easily get ID from email without admin rights.
            // Hack: We will store email in `to_user_id` for this MVP or try to find user.
            
            // Better approach: The message I received has `created_by` (email).
            // I'll reply to that email. 
            // But `to_user_id` expects an ID likely for other logic.
            // Let's try to find user by email.
            // base44.entities.User.list({ filter: { email: ... } }) -> Works!
            
            const users = await base44.entities.User.list({ filter: { email: selectedConversation.other_user_email } });
            const recipientId = users[0]?.id;
            
            if (!recipientId) {
                // If we can't find them (maybe admin/system), we can't reply easily.
                console.error("Recipient not found");
                return;
            }

            await base44.entities.Message.create({
                content: newMessage,
                listing_id: selectedConversation.listing_id,
                to_user_id: recipientId,
                from_user_id: currentUser.id,
                is_read: false
            });

            setNewMessage("");
            // Refresh chat
            openConversation(selectedConversation);
        } catch (error) {
            console.error("Failed to send", error);
        }
    };

    if (loading) {
        return <div className="flex justify-center p-12"><Loader2 className="animate-spin" /></div>;
    }

    return (
        <div className="bg-white rounded-3xl shadow-sm border border-slate-200 min-h-[600px] flex overflow-hidden">
            {/* Sidebar List */}
            <div className={`w-full md:w-1/3 border-r border-slate-100 flex flex-col ${selectedConversation ? 'hidden md:flex' : 'flex'}`}>
                <div className="p-6 border-b border-slate-100">
                    <h2 className="text-xl font-bold">Messages</h2>
                </div>
                <div className="overflow-y-auto flex-1">
                    {conversations.length === 0 ? (
                        <div className="p-8 text-center text-slate-500">
                            <MessageCircle className="w-8 h-8 mx-auto mb-2 text-slate-300" />
                            <p>No messages yet</p>
                        </div>
                    ) : (
                        conversations.map((conv, i) => (
                            <div 
                                key={i}
                                onClick={() => openConversation(conv)}
                                className={`p-4 border-b border-slate-50 cursor-pointer hover:bg-slate-50 transition-colors ${selectedConversation === conv ? 'bg-indigo-50 border-l-4 border-l-indigo-500' : ''}`}
                            >
                                <div className="flex gap-3">
                                    <div className="w-12 h-12 bg-slate-200 rounded-full shrink-0 overflow-hidden">
                                         {conv.listing.images?.[0] ? (
                                             <img src={conv.listing.images[0]} className="w-full h-full object-cover" />
                                         ) : (
                                             <ImageIcon className="w-6 h-6 m-3 text-slate-400" />
                                         )}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-baseline">
                                            <h3 className="font-semibold truncate">{conv.listing.title}</h3>
                                            <span className="text-xs text-slate-400 whitespace-nowrap">
                                                {formatDistanceToNow(new Date(conv.last_message.created_date), { addSuffix: false })}
                                            </span>
                                        </div>
                                        <p className="text-sm text-slate-500 truncate">{conv.other_user_name}</p>
                                        <p className="text-sm text-slate-400 truncate mt-1">{conv.last_message.content}</p>
                                    </div>
                                </div>
                            </div>
                        ))
                    )}
                </div>
            </div>

            {/* Chat Area */}
            <div className={`w-full md:w-2/3 flex flex-col bg-slate-50 ${!selectedConversation ? 'hidden md:flex' : 'flex'}`}>
                {selectedConversation ? (
                    <>
                        {/* Chat Header */}
                        <div className="p-4 bg-white border-b border-slate-200 flex items-center gap-4 shadow-sm">
                            <Button variant="ghost" size="icon" className="md:hidden" onClick={() => setSelectedConversation(null)}>
                                <ArrowLeft className="w-5 h-5" />
                            </Button>
                            <div className="flex items-center gap-3 flex-1">
                                <Avatar className="w-10 h-10 border border-slate-100">
                                    <AvatarImage src={selectedConversation.listing.images?.[0]} />
                                    <AvatarFallback><User className="w-5 h-5" /></AvatarFallback>
                                </Avatar>
                                <div>
                                    <h3 className="font-bold">{selectedConversation.listing.title}</h3>
                                    <p className="text-xs text-slate-500">ZAR {selectedConversation.listing.price} â€¢ {selectedConversation.other_user_name}</p>
                                </div>
                            </div>
                            <Link to={createPageUrl(`ListingDetails?id=${selectedConversation.listing_id}`)}>
                                <Button variant="outline" size="sm">View Item</Button>
                            </Link>
                        </div>

                        {/* Messages List */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {messages.map((msg, idx) => {
                                const isMe = msg.created_by === currentUser.email;
                                return (
                                    <div key={idx} className={`flex ${isMe ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[80%] px-4 py-3 rounded-2xl shadow-sm text-sm ${
                                            isMe 
                                                ? 'bg-indigo-600 text-white rounded-tr-sm' 
                                                : 'bg-white text-slate-800 border border-slate-100 rounded-tl-sm'
                                        }`}>
                                            {msg.content}
                                            <div className={`text-[10px] mt-1 text-right ${isMe ? 'text-indigo-200' : 'text-slate-400'}`}>
                                                {new Date(msg.created_date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {/* Input */}
                        <form onSubmit={sendMessage} className="p-4 bg-white border-t border-slate-200 flex gap-2">
                            <Input 
                                value={newMessage}
                                onChange={(e) => setNewMessage(e.target.value)}
                                placeholder="Type a message..."
                                className="rounded-full bg-slate-50 border-0 focus-visible:ring-1"
                            />
                            <Button type="submit" size="icon" className="rounded-full bg-indigo-600 hover:bg-indigo-700" disabled={!newMessage.trim()}>
                                <Send className="w-4 h-4" />
                            </Button>
                        </form>
                    </>
                ) : (
                    <div className="flex-1 flex items-center justify-center flex-col text-slate-400">
                        <MessageCircle className="w-16 h-16 mb-4 opacity-20" />
                        <p>Select a conversation to start chatting</p>
                    </div>
                )}
            </div>
        </div>
    );
}

// Helper for mobile back button
function ArrowLeft({ className }) {
    return (
        <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="m12 19-7-7 7-7"/>
            <path d="M19 12H5"/>
        </svg>
    );
}
function MessageCircle({ className }) {
    return (
        <svg className={className} width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
        </svg>
    );
}
